<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>微距OCR识别器</title>
  <style>
    /* 样式保持不变 */
  </style>
</head>
<body>
<h2 style="font-size: 16px; margin: 5px 0;">微距OCR</h2>

<!-- 视频预览 -->
<video id="videoPreview" autoplay playsinline></video>

<!-- 拍照后的取景框 -->
<img id="capturedImage" alt="Captured Image">

<!-- 控制按钮 -->
<div class="button-group">
  <button id="startCamera">开启摄像头</button>
  <button id="captureBtn" disabled>拍照识别</button>
  <button id="resetBtn" disabled>重置</button>
  <button id="copyBtn" disabled>复制结果</button>
</div>

<!-- 新增遮罩层 -->
<div class="overlay" id="overlay">
  <div class="loading">识别中...</div>
  <div class="overlay-text">请保持手机稳定</div>
</div>

<!-- 识别结果 -->
<textarea
        id="result"
        placeholder="识别结果将显示在这里..."
        readonly
></textarea>

<script>
  const video = document.getElementById('videoPreview');
  const capturedImage = document.getElementById('capturedImage');
  const captureBtn = document.getElementById('captureBtn');
  const startCameraBtn = document.getElementById('startCamera');
  const resetBtn = document.getElementById('resetBtn');
  const copyBtn = document.getElementById('copyBtn');
  const overlay = document.getElementById('overlay');
  let mediaStream = null;

  // 百度 OCR 的 API Key 和 Secret Key
  const API_KEY = 'tHb9oikV9eC9P7shXn0TN1N4';
  const SECRET_KEY = 'jj597OSwfkhdTB8sVBHTgE6oT54Tqt5g';
  const ACCESS_TOKEN_URL = `https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${API_KEY}&client_secret=${SECRET_KEY}`;

  // 获取百度 OCR 的 Access Token
  async function getAccessToken() {
    const response = await fetch(ACCESS_TOKEN_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    });
    const data = await response.json();
    return data.access_token;
  }

  // 调用百度 OCR 识别图片
  async function recognizeImageWithBaiduOCR(imageBase64) {
    const accessToken = await getAccessToken();
    const url = `https://aip.baidubce.com/rest/2.0/ocr/v1/general_basic?access_token=${accessToken}`;

    const formData = new FormData();
    formData.append('image', imageBase64.split(',')[1]); // 去掉 Base64 前缀
    formData.append('language_type', 'CHN_ENG'); // 支持中英文

    const response = await fetch(url, {
      method: 'POST',
      body: formData,
    });
    const result = await response.json();
    return result.words_result.map(item => item.words).join('\n');
  }

  // 获取微距摄像头
  async function getMacroCamera() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(device => device.kind === 'videoinput');

    // 优先选择后置摄像头
    const rearCamera = videoDevices.find(device =>
            device.label.toLowerCase().includes('back') ||
            device.label.toLowerCase().includes('rear')
    );

    return rearCamera ? rearCamera.deviceId : null;
  }

  // 启动摄像头
  startCameraBtn.addEventListener('click', async () => {
    try {
      const macroCameraId = await getMacroCamera();
      if (!macroCameraId) {
        alert('未找到微距摄像头，将使用默认摄像头');
      }

      const constraints = {
        video: {
          deviceId: macroCameraId ? { exact: macroCameraId } : undefined,
          facingMode: macroCameraId ? undefined : { ideal: 'environment' },
          width: { ideal: 1280 },  // 提高分辨率
          height: { ideal: 720 },
          focusMode: 'continuous', // 启用连续对焦
          advanced: [{ focusMode: 'manual', focusDistance: 0.1 }] // 微距模式
        }
      };

      mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = mediaStream;
      captureBtn.disabled = false;
      startCameraBtn.textContent = '摄像头已开启';
    } catch (error) {
      alert('请允许摄像头权限\n错误信息: ' + error.message);
    }
  });

  // 拍照识别
  captureBtn.addEventListener('click', async () => {
    if (!mediaStream) return;

    // 显示遮罩
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // 禁止滚动

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);

    // 显示拍照后的图像
    capturedImage.src = canvas.toDataURL('image/jpeg', 0.9);
    capturedImage.style.display = 'block';
    video.style.display = 'none'; // 隐藏摄像头预览

    try {
      const imageBase64 = canvas.toDataURL('image/jpeg', 0.9);
      const text = await recognizeImageWithBaiduOCR(imageBase64);
      document.getElementById('result').value = text;
      copyBtn.disabled = false;
      resetBtn.disabled = false; // 启用重置按钮
    } catch (error) {
      alert('识别失败: ' + error.message);
    } finally {
      overlay.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  });

  // 重置功能
  resetBtn.addEventListener('click', () => {
    // 清除取景框
    capturedImage.src = '';
    capturedImage.style.display = 'none';
    video.style.display = 'block'; // 重新显示摄像头预览

    // 清除识别结果
    document.getElementById('result').value = '';
    copyBtn.disabled = true;
    resetBtn.disabled = true;

    // 重新启用摄像头
    if (mediaStream) {
      mediaStream.getTracks().forEach(track => track.stop());
      mediaStream = null;
    }
    startCameraBtn.textContent = '开启摄像头';
    captureBtn.disabled = true;
  });

  // 复制结果
  copyBtn.addEventListener('click', () => {
    const result = document.getElementById('result');
    result.select();
    try {
      navigator.clipboard.writeText(result.value);
      alert('已复制到剪贴板');
    } catch (error) {
      alert('复制失败，请手动选择文本');
    }
  });

  // 关闭摄像头
  window.addEventListener('beforeunload', () => {
    if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
  });
</script>
</body>
</html>
