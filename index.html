<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ‹ç…§OCR</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 15px;
            font-family: Arial;
            background: #f0f2f5;
        }
        #previewContainer {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        #videoPreview, #canvasPreview {
            width: 100%;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #000;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            z-index: 1000;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2em;
        }
        .selection-box {
            position: absolute;
            border: 2px dashed #ff4757;
            background: rgba(255,71,87,0.1);
            pointer-events: none;
        }
        .button-group {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            flex: 1;
            min-width: 120px;
            transition: 0.3s;
        }
        #startCamera {
            background: #2ed573;
            color: white;
        }
        #captureBtn {
            background: #1e90ff;
            color: white;
        }
        #resetBtn {
            background: #ffa502;
            color: white;
        }
        #cancelSelection {
            background: #ff4757;
            color: white;
        }
        #copyBtn {
            background: #2ed573;
            color: white;
        }
        button:disabled {
            background: #ced6e0 !important;
            cursor: not-allowed;
        }
        #result {
            width: 100%;
            height: 200px;
            padding: 12px;
            margin-top: 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-size: 16px;
        }
        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            display: none;
            z-index: 1001;
        }
    </style>
</head>
<body>
<h2>ğŸ“· æ™ºèƒ½æ‹ç…§OCR</h2>

<div id="previewContainer">
    <video id="videoPreview" autoplay playsinline></video>
    <canvas id="canvasPreview"></canvas>
    <div class="overlay" id="overlay">è¯†åˆ«ä¸­...</div>
</div>

<div class="button-group">
    <button id="startCamera">æ‰“å¼€æ‘„åƒå¤´</button>
    <button id="captureBtn" disabled>æ‹ç…§è¯†åˆ«</button>
    <button id="resetBtn" disabled>é‡æ–°æ¡†é€‰</button>
    <button id="cancelSelection" disabled>å–æ¶ˆ</button>
    <button id="copyBtn" disabled>å¤åˆ¶ç»“æœ</button>
</div>

<textarea id="result" placeholder="è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>

<div class="tooltip" id="tooltip"></div>

<script>
    const video = document.getElementById('videoPreview');
    const canvasPreview = document.getElementById('canvasPreview');
    const overlay = document.getElementById('overlay');
    const tooltip = document.getElementById('tooltip');

    let mediaStream = null;
    let isSelecting = false;
    let startX = 0, startY = 0;
    let selectionBox = null;

    // æ‘„åƒå¤´æ§åˆ¶
    document.getElementById('startCamera').addEventListener('click', async () => {
        try {
            mediaStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }
            });
            video.srcObject = mediaStream;
            enableControls(true);
            showTooltip("æ‘„åƒå¤´å·²å¼€å¯");
        } catch (error) {
            alert('æ‘„åƒå¤´æƒé™è¢«æ‹’ç»: ' + error.message);
        }
    });

    // æ‹ç…§åŠŸèƒ½
    document.getElementById('captureBtn').addEventListener('click', () => {
        canvasPreview.width = video.videoWidth;
        canvasPreview.height = video.videoHeight;
        const ctx = canvasPreview.getContext('2d');
        ctx.drawImage(video, 0, 0);

        video.style.display = 'none';
        canvasPreview.style.display = 'block';
        enableControls(false);
        initAreaSelection();
    });

    // åŒºåŸŸé€‰æ‹©åŠŸèƒ½
    function initAreaSelection() {
        isSelecting = true;
        canvasPreview.style.cursor = 'crosshair';

        // æ¡Œé¢ç«¯äº‹ä»¶
        canvasPreview.addEventListener('mousedown', startSelection);
        canvasPreview.addEventListener('mousemove', drawSelection);
        canvasPreview.addEventListener('mouseup', endSelection);

        // ç§»åŠ¨ç«¯äº‹ä»¶
        canvasPreview.addEventListener('touchstart', touchStart);
        canvasPreview.addEventListener('touchmove', touchMove);
        canvasPreview.addEventListener('touchend', touchEnd);

        document.getElementById('resetBtn').disabled = false;
        document.getElementById('cancelSelection').disabled = false;
    }

    function startSelection(e) {
        e.preventDefault();
        const rect = canvasPreview.getBoundingClientRect();
        startX = (e.clientX || e.touches[0].clientX) - rect.left;
        startY = (e.clientY || e.touches[0].clientY) - rect.top;

        selectionBox = document.createElement('div');
        selectionBox.className = 'selection-box';
        previewContainer.appendChild(selectionBox);
    }

    function drawSelection(e) {
        if (!isSelecting || !selectionBox) return;

        const rect = canvasPreview.getBoundingClientRect();
        const currentX = (e.clientX || e.touches[0].clientX) - rect.left;
        const currentY = (e.clientY || e.touches[0].clientY) - rect.top;

        const width = currentX - startX;
        const height = currentY - startY;

        selectionBox.style.left = Math.min(startX, currentX) + 'px';
        selectionBox.style.top = Math.min(startY, currentY) + 'px';
        selectionBox.style.width = Math.abs(width) + 'px';
        selectionBox.style.style.height = Math.abs(height) + 'px';
    }

    async function endSelection() {
        isSelecting = false;
        canvasPreview.style.cursor = 'default';

        if (!selectionBox) return;

        const rect = selectionBox.getBoundingClientRect();
        const canvasRect = canvasPreview.getBoundingClientRect();

        const x = rect.left - canvasRect.left;
        const y = rect.top - canvasRect.top;
        const width = rect.width;
        const height = rect.height;

        selectionBox.remove();
        selectionBox = null;

        if (width > 10 && height > 10) {
            await recognizeArea(x, y, width, height);
        }

        resetPreview();
    }

    // OCRè¯†åˆ«
    async function recognizeArea(x, y, w, h) {
        overlay.style.display = 'flex';

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = w;
        tempCanvas.height = h;
        const ctx = tempCanvas.getContext('2d');
        ctx.drawImage(canvasPreview, x, y, w, h, 0, 0, w, h);

        try {
            const { data: { text } } = await Tesseract.recognize(
                tempCanvas,
                'chi_sim+eng',
                { logger: m => console.log(m.status) }
            );
            document.getElementById('result').value = text.trim();
            document.getElementById('copyBtn').disabled = false;
        } catch (error) {
            alert('è¯†åˆ«é”™è¯¯: ' + error.message);
        } finally {
            overlay.style.display = 'none';
        }
    }

    // è¾…åŠ©åŠŸèƒ½
    function enableControls(isCameraOn) {
        document.getElementById('captureBtn').disabled = !isCameraOn;
        document.getElementById('resetBtn').disabled = true;
        document.getElementById('cancelSelection').disabled = true;
    }

    function resetPreview() {
        canvasPreview.style.display = 'none';
        video.style.display = 'block';
        enableControls(true);
    }

    function showTooltip(text) {
        tooltip.style.display = 'block';
        tooltip.textContent = text;
        setTimeout(() => tooltip.style.display = 'none', 2000);
    }

    // æŒ‰é’®äº‹ä»¶
    document.getElementById('cancelSelection').addEventListener('click', resetPreview);
    document.getElementById('resetBtn').addEventListener('click', () => {
        previewContainer.querySelectorAll('.selection-box').forEach(box => box.remove());
        initAreaSelection();
    });
    document.getElementById('copyBtn').addEventListener('click', () => {
        navigator.clipboard.writeText(result.value);
        showTooltip("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
    });

    // æ¸…ç†èµ„æº
    window.addEventListener('beforeunload', () => {
        if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
    });

    // ç§»åŠ¨ç«¯äº‹ä»¶é€‚é…
    function touchStart(e) {
        startSelection(e.touches[0]);
    }
    function touchMove(e) {
        drawSelection(e.touches[0]);
    }
    function touchEnd(e) {
        endSelection();
    }
</script>
</body>
</html>
