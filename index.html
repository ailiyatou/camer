<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>手机拍照OCR</title>
  <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 15px;
      font-family: Arial;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #videoPreview {
      width: 235px;
      height: 50px;
      border: 2px solid #ddd;
      object-fit: cover;
    }
    #result {
      width: 100%;
      height: 200px;
      padding: 10px;
      margin-top: 15px;
      border: 1px solid #ccc;
      resize: vertical;
      font-size: 16px;
    }
    .button-group {
      margin: 10px 0;
    }
    .loading {
      display: none;
      color: #666;
      margin: 10px 0;
    }
    /* 遮罩层样式 */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      z-index: 9999;
    }
  </style>
</head>
<body>
<h2>手机拍照OCR</h2>

<!-- 视频预览 -->
<video id="videoPreview" autoplay playsinline></video>

<!-- 控制按钮 -->
<div class="button-group">
  <button id="startCamera">打开摄像头</button>
  <button id="captureBtn" disabled>拍照识别</button>
  <button id="copyBtn" disabled>复制结果</button>
</div>

<!-- 加载提示 -->
<div class="loading" id="loading">识别中...</div>

<!-- 识别结果 -->
<textarea
        id="result"
        placeholder="识别结果将显示在这里..."
        readonly
></textarea>

<!-- 遮罩层 -->
<div class="overlay" id="overlay"></div>

<script>
  const video = document.getElementById('videoPreview');
  const captureBtn = document.getElementById('captureBtn');
  const startCameraBtn = document.getElementById('startCamera');
  const copyBtn = document.getElementById('copyBtn');
  const loading = document.getElementById('loading');
  const overlay = document.getElementById('overlay');

  let mediaStream = null;

  // 打开摄像头
  startCameraBtn.addEventListener('click', async () => {
    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" } // 优先使用后置摄像头
      });
      video.srcObject = mediaStream;
      captureBtn.disabled = false;
    } catch (error) {
      alert('请允许摄像头权限\n错误信息: ' + error.message);
    }
  });

  // 拍照识别
  captureBtn.addEventListener('click', async () => {
    if (!mediaStream) return;

    // 显示遮罩和加载提示
    overlay.style.display = 'block';
    loading.style.display = 'block';
    captureBtn.disabled = true;

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);

    try {
      canvas.toBlob(async (blob) => {
        const { data: { text } } = await Tesseract.recognize(
                new File([blob], 'capture.jpg'),
                'eng+chi_sim',
                { logger: m => console.log(m) }
        );
        document.getElementById('result').value = text;
        copyBtn.disabled = false;
      }, 'image/jpeg');
    } catch (error) {
      alert('识别失败: ' + error.message);
    } finally {
      // 关闭遮罩和加载提示
      overlay.style.display = 'none';
      loading.style.display = 'none';
      captureBtn.disabled = false;
    }
  });

  // 复制结果
  copyBtn.addEventListener('click', () => {
    const result = document.getElementById('result');
    result.select();
    try {
      navigator.clipboard.writeText(result.value);
      alert('已复制到剪贴板');
    } catch (error) {
      alert('复制失败，请手动选择文本');
    }
  });

  // 关闭摄像头
  window.addEventListener('beforeunload', () => {
    if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
  });
</script>
</body>
</html>
